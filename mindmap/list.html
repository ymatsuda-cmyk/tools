<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒã‚¤ãƒ³ãƒ‰ãƒãƒƒãƒ—ç®¡ç†</title>
    <style>
                .main-flex {
                    display: flex;
                    gap: 24px;
                }
                .folder-tree {
                    width: 260px;
                    min-width: 180px;
                    background: #fff;
                    border-radius: 12px;
                    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
                    padding: 16px 8px 16px 16px;
                    margin-bottom: 24px;
                    max-height: 70vh;
                    overflow-y: auto;
                }
                .folder-list {
                    list-style: none;
                    padding-left: 0;
                }
                .folder-item {
                    display: flex;
                    align-items: center;
                    justify-content: space-between;
                    margin-bottom: 4px;
                    padding: 2px 0 2px 8px;
                    border-radius: 6px;
                    cursor: pointer;
                    transition: background 0.15s;
                }
                .folder-item.selected {
                    background: #e3f2fd;
                    font-weight: bold;
                }
                .folder-actions {
                    margin-left: auto;
                    display: flex;
                    gap: 2px;
                }
                .folder-btn {
                    background: none;
                    border: none;
                    color: #6c757d;
                    cursor: pointer;
                    font-size: 15px;
                    border-radius: 4px;
                    padding: 2px 4px;
                }
                .folder-btn:hover {
                    background: #f1f3f4;
                }
                @media (max-width: 900px) {
                    .main-flex {
                        flex-direction: column;
                    }
                    .folder-tree {
                        width: 100%;
                        max-width: 100vw;
                        margin-bottom: 12px;
                    }
                }
                @media (max-width: 600px) {
                    .container {
                        padding: 6px;
                    }
                    .main-flex {
                        gap: 8px;
                    }
                    .folder-tree {
                        padding: 8px 2px 8px 8px;
                        font-size: 15px;
                    }
                }
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f8f9fa;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: white;
            padding: 24px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            font-size: 24px;
            font-weight: 600;
            color: #2c3e50;
        }

        .toolbar {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .header-menu {
            position: relative;
        }

        .menu-toggle-btn {
            background: #17a2b8;
            color: white;
            border: none;
            border-radius: 6px;
            padding: 12px 20px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: background 0.2s;
        }

        .menu-toggle-btn:hover {
            background: #138496;
        }

        .header-menu-dropdown {
            position: absolute;
            top: 100%;
            right: 0;
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 1000;
            min-width: 150px;
            display: none;
            margin-top: 4px;
        }

        .header-menu-dropdown.show {
            display: block;
        }

        .header-menu-item {
            padding: 12px 16px;
            cursor: pointer;
            border-bottom: 1px solid #f1f3f4;
            font-size: 14px;
            color: #333;
            transition: background 0.2s;
        }

        .header-menu-item:hover {
            background: #f8f9fa;
        }

        .header-menu-item:last-child {
            border-bottom: none;
        }

        .btn {
            padding: 12px 20px;
            background: #17a2b8;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: background 0.2s;
        }

        .btn:hover {
            background: #138496;
        }

        .mindmap-container {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .mindmap-item {
            display: flex;
            align-items: center;
            padding: 16px 24px;
            border-bottom: 1px solid #e9ecef;
            transition: background 0.2s;
        }

        .mindmap-item:hover {
            background: #f8f9fa;
        }

        .mindmap-item:last-child {
            border-bottom: none;
        }

        /* ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ç”¨ã‚¹ã‚¿ã‚¤ãƒ« */
        .focusable {
            outline: none;
        }

        .focusable:focus {
            outline: 2px solid #17a2b8;
            outline-offset: 2px;
        }

        .folder-item.focusable:focus {
            background: #e3f2fd;
            outline: 2px solid #17a2b8;
        }

        .mindmap-item.focusable:focus {
            background: #f0f8ff;
            outline: 2px solid #17a2b8;
        }

        .mindmap-info {
            flex: 1;
        }

        .mindmap-name {
            font-size: 16px;
            font-weight: 500;
            color: #2c3e50;
            text-decoration: none;
            margin-bottom: 4px;
            display: block;
            cursor: pointer;
        }

        .mindmap-name:hover {
            color: #17a2b8;
            text-decoration: underline;
        }

        .mindmap-meta {
            font-size: 13px;
            color: #6c757d;
        }

        .mindmap-actions {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .menu-btn {
            background: none;
            border: none;
            color: #6c757d;
            cursor: pointer;
            padding: 8px;
            border-radius: 4px;
            font-size: 18px;
            transition: all 0.2s;
        }

        .menu-btn:hover {
            background: #f8f9fa;
            color: #495057;
        }

        .context-menu {
            position: fixed;
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 1000;
            min-width: 160px;
            display: none;
        }

        .context-menu-item {
            padding: 12px 16px;
            cursor: pointer;
            border-bottom: 1px solid #f1f3f4;
            font-size: 14px;
            color: #333;
        }

        .context-menu-item:hover {
            background: #f8f9fa;
        }

        .context-menu-item:last-child {
            border-bottom: none;
        }

        .context-menu-item.danger {
            color: #dc3545;
        }

        .context-menu-item.danger:hover {
            background: #fee;
        }

        .empty-state {
            text-align: center;
            padding: 80px 20px;
            color: #6c757d;
        }

        .empty-state h3 {
            font-size: 18px;
            margin-bottom: 8px;
            color: #495057;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
        }

        .modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            padding: 24px;
            min-width: 400px;
            max-width: 90vw;
        }

        .modal-header {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 16px;
            color: #2c3e50;
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-group label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
            color: #495057;
        }

        .form-control {
            width: 100%;
            padding: 12px;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            font-size: 14px;
        }

        .modal-actions {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
        }

        .btn-secondary {
            background: #6c757d;
        }

        .btn-secondary:hover {
            background: #545b62;
        }

        @media (max-width: 600px) {
            .mindmap-item {
                padding: 12px 16px;
            }

            .mindmap-name {
                font-size: 15px;
            }

            .mindmap-meta {
                font-size: 12px;
            }

            .menu-btn {
                font-size: 16px;
                padding: 6px;
            }
        }
    </style>
</head>
<body>
            <!-- ãƒ•ã‚©ãƒ«ãƒ€ç”¨ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆãƒ¡ãƒ‹ãƒ¥ãƒ¼ -->
            <div id="folder-context-menu" class="context-menu">
                <div class="context-menu-item" onclick="editFolderFromMenu()">âœï¸ åå‰å¤‰æ›´</div>
                <div class="context-menu-item" onclick="moveFolderFromMenu()">ğŸ“‚ ãƒ•ã‚©ãƒ«ãƒ€ç§»å‹•</div>
                <div class="context-menu-item danger" onclick="deleteFolderFromMenu()">ğŸ—‘ï¸ å‰Šé™¤</div>
            </div>
        
        <!-- ãƒ•ã‚©ãƒ«ãƒ€ç§»å‹•ãƒ¢ãƒ¼ãƒ€ãƒ« -->
        <div id="move-modal" class="modal">
            <div class="modal-content">
                <div class="modal-header">ãƒ•ã‚©ãƒ«ãƒ€ã¸ç§»å‹•</div>
                <div class="form-group">
                    <label for="move-folder-select">ç§»å‹•å…ˆãƒ•ã‚©ãƒ«ãƒ€:</label>
                    <select id="move-folder-select" class="form-control"></select>
                </div>
                <div class="modal-actions">
                    <button class="btn btn-secondary" onclick="closeModal('move-modal')">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                    <button class="btn">ç§»å‹•</button>
                </div>
            </div>
        </div>
    <div class="container">
        <div class="header">
            <h1>ãƒã‚¤ãƒ³ãƒ‰ãƒãƒƒãƒ—</h1>
            <div class="toolbar">
                <button class="btn" onclick="createNewMindMap()">
                    æ–°è¦ä½œæˆ
                </button>
                <div class="header-menu">
                    <button class="menu-toggle-btn" onclick="toggleHeaderMenu(event)">
                        ãƒ¡ãƒ‹ãƒ¥ãƒ¼ â–¼
                    </button>
                    <div class="header-menu-dropdown" id="header-menu">
                        <div class="header-menu-item" onclick="importMindMap(); hideHeaderMenu();">ğŸ“ ã‚¤ãƒ³ãƒãƒ¼ãƒˆ</div>
                        <div class="header-menu-item" onclick="exportAllMindMaps(); hideHeaderMenu();">ğŸ“„ ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="main-flex">
            <div class="folder-tree">
                <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px;">
                    <span style="font-weight:600;">ãƒ•ã‚©ãƒ«ãƒ€</span>
                    <button class="btn btn-secondary" style="padding:4px 10px;font-size:13px;" onclick="showCreateFolderModal()">ï¼‹</button>
                </div>
                <ul id="folder-list" class="folder-list"></ul>
            </div>
            <div style="flex:1;min-width:0;">
                <div id="mindmap-container" class="mindmap-container">
                    <!-- å‹•çš„ã«ç”Ÿæˆã•ã‚Œã¾ã™ -->
                </div>
            </div>
        </div>
        <!-- ãƒ•ã‚©ãƒ«ãƒ€ä½œæˆãƒ¢ãƒ¼ãƒ€ãƒ« -->
        <div id="folder-modal" class="modal">
            <div class="modal-content">
                <div class="modal-header" id="folder-modal-title">æ–°ã—ã„ãƒ•ã‚©ãƒ«ãƒ€</div>
                <div class="form-group">
                    <label for="folder-name">ãƒ•ã‚©ãƒ«ãƒ€å:</label>
                    <input type="text" id="folder-name" class="form-control" placeholder="ãƒ•ã‚©ãƒ«ãƒ€åã‚’å…¥åŠ›">
                </div>
                <div class="form-group">
                    <label for="folder-parent">è¦ªãƒ•ã‚©ãƒ«ãƒ€:</label>
                    <select id="folder-parent" class="form-control"></select>
                </div>
                <div class="modal-actions">
                    <button class="btn btn-secondary" onclick="closeModal('folder-modal')">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                    <button class="btn" id="folder-modal-confirm-btn" onclick="confirmCreateFolder()">ä½œæˆ</button>
                </div>
            </div>
        </div>
    </div>

    <!-- å€‹åˆ¥ãƒ¡ãƒ‹ãƒ¥ãƒ¼ -->
    <div id="context-menu" class="context-menu">
        <div class="context-menu-item" onclick="exportMindMap(currentContextMindMapId)">ğŸ“„ å€‹åˆ¥ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</div>
        <div class="context-menu-item" onclick="editName(currentContextMindMapId)">âœï¸ åå‰å¤‰æ›´</div>
        <div class="context-menu-item" onclick="showMoveModal(currentContextMindMapId)">ğŸ“‚ ãƒ•ã‚©ãƒ«ãƒ€ç§»å‹•</div>
        <div class="context-menu-item danger" onclick="deleteMindMap(currentContextMindMapId)">ğŸ—‘ï¸ å‰Šé™¤</div>
    </div>

    <!-- æ–°è¦ä½œæˆãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="create-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">æ–°ã—ã„ãƒã‚¤ãƒ³ãƒ‰ãƒãƒƒãƒ—</div>
            <div class="form-group">
                <label for="new-name">åå‰:</label>
                <input type="text" id="new-name" class="form-control" placeholder="ãƒã‚¤ãƒ³ãƒ‰ãƒãƒƒãƒ—ã®åå‰ã‚’å…¥åŠ›">
            </div>
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="closeModal('create-modal')">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                <button class="btn" onclick="confirmCreateMindMap()">ä½œæˆ</button>
            </div>
        </div>
    </div>

    <!-- åå‰ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="edit-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">åå‰ã‚’å¤‰æ›´</div>
            <div class="form-group">
                <label for="edit-name">æ–°ã—ã„åå‰:</label>
                <input type="text" id="edit-name" class="form-control">
            </div>
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="closeModal('edit-modal')">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                <button class="btn" onclick="confirmEditName()">å¤‰æ›´</button>
            </div>
        </div>
    </div>

    <!-- ã‚¤ãƒ³ãƒãƒ¼ãƒˆç”¨ãƒ•ã‚¡ã‚¤ãƒ«å…¥åŠ› -->
    <input type="file" id="import-file" style="display: none;" accept=".json">

    <script>
                    // ãƒ•ã‚©ãƒ«ãƒ€ç§»å‹•ï¼ˆã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‹ã‚‰ï¼‰
                    function moveFolderFromMenu() {
                        console.log('moveFolderFromMenué–‹å§‹, _contextFolderId:', window._contextFolderId);
                        if (window._contextFolderId) {
                            const folderId = window._contextFolderId; // IDã‚’äº‹å‰ã«ä¿å­˜
                            hideFolderContextMenu();
                            showMoveFolderModal(folderId); // ä¿å­˜ã—ãŸIDã‚’ä½¿ç”¨
                        } else {
                            console.log('ã‚¨ãƒ©ãƒ¼: _contextFolderIdãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“');
                        }
                    }

                    // ãƒ•ã‚©ãƒ«ãƒ€ç§»å‹•ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼ˆãƒ•ã‚©ãƒ«ãƒ€ç”¨ï¼‰
                    function showMoveFolderModal(folderId) {
                        console.log('showMoveFolderModalé–‹å§‹:', folderId);
                        console.log('ç¾åœ¨ã®foldersãƒ‡ãƒ¼ã‚¿:', folders);
                        // ç§»å‹•å…ˆé¸æŠãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’æµç”¨
                        const select = document.getElementById('move-folder-select');
                        select.innerHTML = '';
                        // å­å­«åˆ¤å®šç”¨
                        function isDescendant(targetId, parentId) {
                            const parent = folders.find(f => f.id === parentId);
                            if (!parent || !parent.children) return false;
                            for (const childId of parent.children) {
                                if (childId === targetId) return true;
                                if (isDescendant(targetId, childId)) return true;
                            }
                            return false;
                        }
                        function addOption(folder, depth = 0) {
                            console.log(`addOption: ${folder.name} (id: ${folder.id}), depth: ${depth}`);
                            // è‡ªåˆ†è‡ªèº«ã¨å­å­«ã¯é™¤å¤–
                            if (folder.id === folderId) {
                                console.log(`  é™¤å¤–: è‡ªåˆ†è‡ªèº« ${folder.name}`);
                                return;
                            }
                            if (isDescendant(folder.id, folderId)) {
                                console.log(`  é™¤å¤–: å­å­« ${folder.name}`);
                                return;
                            }
                            const opt = document.createElement('option');
                            opt.value = folder.id;
                            opt.textContent = 'ã€€'.repeat(depth) + folder.name;
                            select.appendChild(opt);
                            console.log(`  è¿½åŠ : ${opt.textContent}`);
                            (folder.children||[]).forEach(childId => {
                                const child = folders.find(f => f.id === childId);
                                if (child) addOption(child, depth+1);
                            });
                        }
                        const rootFolder = folders.find(f => f.id === 'root');
                        console.log('rootFolder:', rootFolder);
                        if (rootFolder) addOption(rootFolder, 0);
                        console.log('æœ€çµ‚çš„ãªselect optionsæ•°:', select.options.length);
                        // ç¾åœ¨ã®è¦ªã‚’åˆæœŸé¸æŠ
                        const folder = folders.find(f => f.id === folderId);
                        if (folder) select.value = folder.parentId || 'root';
                        // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚¿ã‚¤ãƒˆãƒ«å¤‰æ›´
                        document.querySelector('#move-modal .modal-header').textContent = 'ãƒ•ã‚©ãƒ«ãƒ€ã®ç§»å‹•';
                        // ç§»å‹•ç¢ºå®šãƒœã‚¿ãƒ³ã®æŒ™å‹•ã‚’ãƒ•ã‚©ãƒ«ãƒ€ç”¨ã«å·®ã—æ›¿ãˆ
                        const confirmBtn = document.querySelector('#move-modal .modal-actions .btn:not(.btn-secondary)');
                        // onclickã‚’ç›´æ¥é–¢æ•°ä»£å…¥ã—ã€ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã®é‡è¤‡ã‚’é˜²ã
                        confirmBtn.onclick = function() {
                            console.log('ãƒ•ã‚©ãƒ«ãƒ€ç§»å‹•ç¢ºå®šãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯:', folderId);
                            const newParentId = select.value;
                            console.log('ç§»å‹•å…ˆ:', newParentId);
                            moveFolder(folderId, newParentId);
                            closeModal('move-modal');
                            confirmBtn.onclick = null;
                        };
                        showModal('move-modal');
                    }

                    function moveFolder(folderId, newParentId) {
                        console.log('moveFolderé–‹å§‹:', { folderId, newParentId });
                        const folder = folders.find(f => f.id === folderId);
                        if (!folder) {
                            console.log('ã‚¨ãƒ©ãƒ¼: ãƒ•ã‚©ãƒ«ãƒ€ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“:', folderId);
                            return;
                        }
                        console.log('ç§»å‹•å¯¾è±¡ãƒ•ã‚©ãƒ«ãƒ€:', folder);
                        // æ—§è¦ªã‹ã‚‰é™¤å¤–
                        const oldParent = folders.find(f => f.id === folder.parentId);
                        if (oldParent) oldParent.children = oldParent.children.filter(cid => cid !== folder.id);
                        // æ–°è¦ªã«è¿½åŠ 
                        const newParent = folders.find(f => f.id === newParentId);
                        if (newParent) {
                            if (!Array.isArray(newParent.children)) newParent.children = [];
                            if (!newParent.children.includes(folder.id)) newParent.children.push(folder.id);
                        }
                        folder.parentId = newParentId;
                        console.log('moveFolder: folders before save', JSON.stringify(folders));
                        saveFolders();
                        console.log('moveFolder: folders after save', JSON.stringify(folders));
                        // ç§»å‹•å¾Œã«é¸æŠãƒ•ã‚©ãƒ«ãƒ€ã‚’ç§»å‹•å…ˆã«å¤‰æ›´ã—ã€UIã‚’å†æç”»
                        selectedFolderId = newParentId;
                        renderFolderTree();
                        renderMindMapList();
                    }
                    // ãƒ•ã‚©ãƒ«ãƒ€ç”¨ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆãƒ¡ãƒ‹ãƒ¥ãƒ¼è¡¨ç¤º
                    function showFolderContextMenu(event, folderId) {
                        console.log('showFolderContextMenué–‹å§‹:', folderId);
                        event.preventDefault();
                        event.stopPropagation();
                        const menu = document.getElementById('folder-context-menu');
                        menu.style.display = 'block';
                        menu.style.left = event.pageX + 'px';
                        menu.style.top = event.pageY + 'px';
                        // ç”»é¢ç«¯ã«è¿‘ã„å ´åˆã®èª¿æ•´
                        const rect = menu.getBoundingClientRect();
                        if (rect.right > window.innerWidth) {
                            menu.style.left = (event.pageX - rect.width) + 'px';
                        }
                        if (rect.bottom > window.innerHeight) {
                            menu.style.top = (event.pageY - rect.height) + 'px';
                        }
                        // ç·¨é›†ãƒ»å‰Šé™¤ç”¨ã«é¸æŠãƒ•ã‚©ãƒ«ãƒ€IDã‚’ä¿å­˜
                        window._contextFolderId = folderId;
                        console.log('_contextFolderIdã‚’è¨­å®š:', window._contextFolderId);
                    }

                    // ãƒ•ã‚©ãƒ«ãƒ€ç”¨ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆãƒ¡ãƒ‹ãƒ¥ãƒ¼éè¡¨ç¤º
                    function hideFolderContextMenu() {
                        const menu = document.getElementById('folder-context-menu');
                        menu.style.display = 'none';
                        window._contextFolderId = null;
                    }

                    // åå‰å¤‰æ›´ï¼ˆã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‹ã‚‰ï¼‰
                    function editFolderFromMenu() {
                        if (window._contextFolderId) {
                            const folderId = window._contextFolderId; // IDã‚’äº‹å‰ã«ä¿å­˜
                            hideFolderContextMenu();
                            showEditFolderModal(folderId); // ä¿å­˜ã—ãŸIDã‚’ä½¿ç”¨
                        }
                    }

                    // å‰Šé™¤ï¼ˆã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‹ã‚‰ï¼‰
                    function deleteFolderFromMenu() {
                        if (window._contextFolderId) {
                            const folderId = window._contextFolderId; // IDã‚’äº‹å‰ã«ä¿å­˜
                            hideFolderContextMenu();
                            deleteFolder(folderId); // ä¿å­˜ã—ãŸIDã‚’ä½¿ç”¨
                        }
                    }

                    window.showFolderContextMenu = showFolderContextMenu;
                    window.hideFolderContextMenu = hideFolderContextMenu;
                    // ãƒ•ã‚©ãƒ«ãƒ€ç§»å‹•ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º
                    let movingMindMapId = null;
                    function showMoveModal(mindMapId) {
                        movingMindMapId = mindMapId;
                        renderMoveFolderOptions();
                        // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚¿ã‚¤ãƒˆãƒ«å¤‰æ›´
                        document.querySelector('#move-modal .modal-header').textContent = 'ãƒ•ã‚©ãƒ«ãƒ€ã¸ç§»å‹•';
                        // ç§»å‹•ç¢ºå®šãƒœã‚¿ãƒ³ã®æŒ™å‹•ã‚’mindmapç”¨ã«å·®ã—æ›¿ãˆ
                        const confirmBtn = document.querySelector('#move-modal .modal-actions .btn:not(.btn-secondary)');
                        confirmBtn.onclick = null;
                        confirmBtn.onclick = confirmMoveMindMap;
                        showModal('move-modal');
                    }
                    function renderMoveFolderOptions() {
                        const select = document.getElementById('move-folder-select');
                        select.innerHTML = '';
                        function addOption(folder, depth = 0) {
                            const opt = document.createElement('option');
                            opt.value = folder.id;
                            opt.textContent = 'ã€€'.repeat(depth) + folder.name;
                            select.appendChild(opt);
                            (folder.children||[]).forEach(childId => {
                                const child = folders.find(f => f.id === childId);
                                if (child) addOption(child, depth+1);
                            });
                        }
                        const rootFolder = folders.find(f => f.id === 'root');
                        if (rootFolder) addOption(rootFolder, 0);
                        // ç¾åœ¨ã®ãƒ•ã‚©ãƒ«ãƒ€ã‚’åˆæœŸé¸æŠ
                        const mindMap = mindMaps.find(m => m.id === movingMindMapId);
                        if (mindMap) select.value = mindMap.folder || 'root';
                    }
                    function confirmMoveMindMap() {
                        const folderId = document.getElementById('move-folder-select').value;
                        const mindMap = mindMaps.find(m => m.id === movingMindMapId);
                        if (mindMap && folderId) {
                            mindMap.folder = folderId;
                            mindMap.updatedAt = Date.now();
                            saveMindMaps();
                            renderMindMapList();
                            closeModal('move-modal');
                        }
                        movingMindMapId = null;
                        hideContextMenu();
                    }
            // ãƒ•ã‚©ãƒ«ãƒ€ãƒ‡ãƒ¼ã‚¿
            let folders = [];
            let selectedFolderId = 'root';
            let editingFolderId = null;
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
        let mindMaps = [];
        let editingMindMapId = null;
        let currentContextMindMapId = null;

        // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‹ã‚‰ãƒã‚¤ãƒ³ãƒ‰ãƒãƒƒãƒ—ãƒ»ãƒ•ã‚©ãƒ«ãƒ€ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿
        function loadMindMaps() {
            try {
                const stored = localStorage.getItem('mindMaps');
                const storedFolders = localStorage.getItem('folders');
                if (stored) {
                    const data = JSON.parse(stored);
                    mindMaps = data.mindMaps || [];
                } else {
                    mindMaps = [];
                }
                if (storedFolders) {
                    folders = JSON.parse(storedFolders);
                } else {
                    folders = [{ id: 'root', name: 'å…¨ä½“', parentId: null, children: [] }];
                }
                
                // URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‹ã‚‰ãƒ•ã‚©ãƒ«ãƒ€IDã‚’å–å¾—
                const urlParams = new URLSearchParams(window.location.search);
                const returnFolderId = urlParams.get('folder') || urlParams.get('returnFolder');
                if (returnFolderId && folders.find(f => f.id === returnFolderId)) {
                    selectedFolderId = returnFolderId;
                    // URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’ã‚¯ãƒªã‚¢ï¼ˆãƒ–ãƒ©ã‚¦ã‚¶å±¥æ­´ã‚’æ±šã•ãªã„ãŸã‚ï¼‰
                    const newUrl = window.location.pathname;
                    window.history.replaceState({}, document.title, newUrl);
                }
                
                renderFolderTree();
                renderMindMapList();
            } catch (error) {
                console.error('ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
                mindMaps = [];
                folders = [{ id: 'root', name: 'å…¨ä½“', parentId: null, children: [] }];
                renderFolderTree();
                renderMindMapList();
            }
        }

        // ãƒã‚¤ãƒ³ãƒ‰ãƒãƒƒãƒ—ãƒªã‚¹ãƒˆã‚’æç”»ï¼ˆé¸æŠä¸­ãƒ•ã‚©ãƒ«ãƒ€ã®ã¿ï¼‰
        function renderMindMapList() {
            const container = document.getElementById('mindmap-container');
            const filtered = mindMaps.filter(m => (m.folder || 'root') === selectedFolderId);
            if (filtered.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <h3>ãƒã‚¤ãƒ³ãƒ‰ãƒãƒƒãƒ—ãŒã‚ã‚Šã¾ã›ã‚“</h3>
                        <p>ã€Œæ–°è¦ä½œæˆã€ãƒœã‚¿ãƒ³ã‹ã‚‰æœ€åˆã®ãƒã‚¤ãƒ³ãƒ‰ãƒãƒƒãƒ—ã‚’ä½œæˆã—ã¾ã—ã‚‡ã†</p>
                    </div>
                `;
                return;
            }
            let tabIndex = 100; // ãƒã‚¤ãƒ³ãƒ‰ãƒãƒƒãƒ—ç”¨ã®tabindexé–‹å§‹å€¤
            container.innerHTML = filtered.map(mindMap => `
                <div class="mindmap-item focusable" data-id="${mindMap.id}" tabindex="${tabIndex++}" 
                     onclick="if (!event.target.closest('button')) openMindMap('${mindMap.id}')"
                     onkeydown="handleMindMapKeydown(event, '${mindMap.id}')">
                    <div class="mindmap-info">
                        <span class="mindmap-name">${escapeHtml(mindMap.name)}</span>
                        <div class="mindmap-meta">
                            ${formatDate(mindMap.updatedAt)} Â· ${countNodes(mindMap.rootNode)} ãƒãƒ¼ãƒ‰
                        </div>
                    </div>
                    <div class="mindmap-actions">
                        <button class="menu-btn" onclick="showContextMenu(event, '${mindMap.id}')" title="ãƒ¡ãƒ‹ãƒ¥ãƒ¼">â‹®</button>
                    </div>
                </div>
            `).join('');
        }

        // ãƒ•ã‚©ãƒ«ãƒ€ãƒ„ãƒªãƒ¼æç”»
        function renderFolderTree() {
            const list = document.getElementById('folder-list');
            list.innerHTML = '';
            let tabIndex = 1; // ãƒ•ã‚©ãƒ«ãƒ€ç”¨ã®tabindexé–‹å§‹å€¤
            function renderNode(folder, depth = 0) {
                const li = document.createElement('li');
                li.className = 'folder-item focusable' + (selectedFolderId === folder.id ? ' selected' : '');
                li.style.paddingLeft = (depth * 18) + 'px';
                li.tabIndex = tabIndex++;
                li.setAttribute('data-folder-id', folder.id);
                // å·¦: ãƒ•ã‚©ãƒ«ãƒ€å, å³: ãƒ¡ãƒ‹ãƒ¥ãƒ¼
                const left = document.createElement('span');
                left.textContent = folder.name;
                li.appendChild(left);
                // è¡Œå…¨ä½“ã‚¯ãƒªãƒƒã‚¯ã§é¸æŠ
                li.onclick = (e) => {
                    // ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚¯ãƒªãƒƒã‚¯æ™‚ã¯ç„¡è¦–
                    if (e.target.closest('button')) return;
                    selectedFolderId = folder.id;
                    renderFolderTree();
                    renderMindMapList();
                };
                // ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã‚¤ãƒ™ãƒ³ãƒˆè¿½åŠ 
                li.addEventListener('keydown', (e) => {
                    handleFolderKeydown(e, folder.id);
                });
                if (folder.id !== 'root') {
                    const right = document.createElement('span');
                    right.style.display = 'flex';
                    right.style.alignItems = 'center';
                    const menuBtn = document.createElement('button');
                    menuBtn.className = 'folder-menu-btn menu-btn';
                    menuBtn.title = 'ãƒ¡ãƒ‹ãƒ¥ãƒ¼';
                    menuBtn.innerHTML = 'â‹®';
                    menuBtn.onclick = (e) => { 
                        console.log('ãƒ•ã‚©ãƒ«ãƒ€ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯:', folder.id);
                        e.stopPropagation(); 
                        window.showFolderContextMenu(e, folder.id); 
                    };
                    right.appendChild(menuBtn);
                    li.appendChild(right);
                }
                list.appendChild(li);
                (folder.children||[]).forEach(childId => {
                    const child = folders.find(f => f.id === childId);
                    if (child) renderNode(child, depth+1);
                });
            }
            const rootFolder = folders.find(f => f.id === 'root');
            if (rootFolder) renderNode(rootFolder, 0);
        // â†ã“ã“ã§é–¢æ•°çµ‚äº†ï¼ˆä¸è¦ãªé–‰ã˜ã‚«ãƒƒã‚³å‰Šé™¤ï¼‰


        }
        // ãƒ•ã‚©ãƒ«ãƒ€ä½œæˆãƒ»ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«
        window.showCreateFolderModal = showCreateFolderModal;
        function showCreateFolderModal() {
            editingFolderId = null;
            document.getElementById('folder-modal-title').textContent = 'æ–°ã—ã„ãƒ•ã‚©ãƒ«ãƒ€';
            document.getElementById('folder-name').value = '';
            renderFolderParentOptions();
            showModal('folder-modal');
            setTimeout(() => document.getElementById('folder-name').focus(), 100);
            document.getElementById('folder-modal-confirm-btn').onclick = confirmCreateFolder;
        }
        function showEditFolderModal(folderId) {
            editingFolderId = folderId;
            const folder = folders.find(f => f.id === folderId);
            document.getElementById('folder-modal-title').textContent = 'ãƒ•ã‚©ãƒ«ãƒ€ç·¨é›†';
            document.getElementById('folder-name').value = folder.name;
            renderFolderParentOptions(folderId);
            showModal('folder-modal');
            setTimeout(() => document.getElementById('folder-name').focus(), 100);
            document.getElementById('folder-modal-confirm-btn').onclick = confirmEditFolder;
        }
        function renderFolderParentOptions(excludeId) {
            const select = document.getElementById('folder-parent');
            select.innerHTML = '';
            function addOption(folder, depth = 0) {
                if (folder.id === excludeId) return;
                const opt = document.createElement('option');
                opt.value = folder.id;
                opt.textContent = 'ã€€'.repeat(depth) + folder.name;
                select.appendChild(opt);
                (folder.children||[]).forEach(childId => {
                    const child = folders.find(f => f.id === childId);
                    if (child) addOption(child, depth+1);
                });
            }
            const rootFolder = folders.find(f => f.id === 'root');
            if (rootFolder) addOption(rootFolder, 0);
            select.value = selectedFolderId;
        }
        function confirmCreateFolder() {
            const name = document.getElementById('folder-name').value.trim();
            const parentId = document.getElementById('folder-parent').value;
            if (!name) { alert('ãƒ•ã‚©ãƒ«ãƒ€åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }
            const id = generateUUID();
            // æ–°ã—ã„ãƒ•ã‚©ãƒ«ãƒ€ã‚’ä½œæˆ
            folders.push({ id, name, parentId, children: [] });
            // è¦ªãƒ•ã‚©ãƒ«ãƒ€ã®childrenã«è¿½åŠ 
            if (parentId) {
                const parent = folders.find(f => f.id === parentId);
                if (parent && !parent.children.includes(id)) parent.children.push(id);
            }
            saveFolders();
            closeModal('folder-modal');
            renderFolderTree();
        }
        function confirmEditFolder() {
            const name = document.getElementById('folder-name').value.trim();
            const parentId = document.getElementById('folder-parent').value;
            if (!name) { alert('ãƒ•ã‚©ãƒ«ãƒ€åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }
            const folder = folders.find(f => f.id === editingFolderId);
            if (!folder) return;
            // è¦ªå¤‰æ›´
            if (folder.parentId !== parentId) {
                // æ—§è¦ªã‹ã‚‰é™¤å¤–
                const oldParent = folders.find(f => f.id === folder.parentId);
                if (oldParent) oldParent.children = oldParent.children.filter(cid => cid !== folder.id);
                // æ–°è¦ªã«è¿½åŠ 
                const newParent = folders.find(f => f.id === parentId);
                if (newParent && !newParent.children.includes(folder.id)) newParent.children.push(folder.id);
                folder.parentId = parentId;
            }
            folder.name = name;
            saveFolders();
            closeModal('folder-modal');
            renderFolderTree();
        }
        function deleteFolder(folderId) {
            if (folderId === 'root') return;
            const folder = folders.find(f => f.id === folderId);
            if (!folder) return;
            if (!confirm(`ãƒ•ã‚©ãƒ«ãƒ€ã€Œ${folder.name}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\né…ä¸‹ã®ãƒã‚¤ãƒ³ãƒ‰ãƒãƒƒãƒ—ã‚‚å…¨ã¦å‰Šé™¤ã•ã‚Œã¾ã™ã€‚`)) return;
            // å­å­«ã‚‚å†å¸°å‰Šé™¤
            function removeFolderAndChildren(id) {
                const f = folders.find(ff => ff.id === id);
                if (!f) return;
                (f.children||[]).forEach(cid => removeFolderAndChildren(cid));
                // é…ä¸‹ãƒã‚¤ãƒ³ãƒ‰ãƒãƒƒãƒ—ã‚‚å‰Šé™¤
                mindMaps = mindMaps.filter(m => (m.folder||'root') !== id);
                // è¦ªã‹ã‚‰é™¤å¤–
                const parent = folders.find(ff => ff.id === f.parentId);
                if (parent) parent.children = parent.children.filter(cid => cid !== id);
                // è‡ªèº«å‰Šé™¤
                folders = folders.filter(ff => ff.id !== id);
            }
            removeFolderAndChildren(folderId);
            saveFolders();
            renderFolderTree();
            renderMindMapList();
        }
        function saveFolders() {
            console.log('saveFoldersé–‹å§‹ - ä¿å­˜å‰folders:', folders);
            localStorage.setItem('folders', JSON.stringify(folders));
            const saved = JSON.parse(localStorage.getItem('folders'));
            console.log('saveFolderså®Œäº† - ä¿å­˜å¾Œç¢ºèª:', saved);
            saveMindMaps();
        }

        // çµ±è¨ˆæƒ…å ±ã‚’æ›´æ–°ï¼ˆUIç°¡ç´ åŒ–ã®ãŸã‚ç„¡åŠ¹åŒ–ï¼‰
        function updateStats() {
            // çµ±è¨ˆè¡¨ç¤ºã‚’å‰Šé™¤ã—ãŸãŸã‚ã€ä½•ã‚‚ã—ãªã„
            return;
        }

        // ãƒãƒ¼ãƒ‰æ•°ã‚’ã‚«ã‚¦ãƒ³ãƒˆï¼ˆå†å¸°ï¼‰
        function countNodes(node) {
            if (!node) return 0;
            let count = 1;
            if (node.children && node.children.length > 0) {
                count += node.children.reduce((sum, child) => sum + countNodes(child), 0);
            }
            return count;
        }

        // å€‹åˆ¥ãƒ¡ãƒ‹ãƒ¥ãƒ¼è¡¨ç¤º
        function showContextMenu(event, mindMapId) {
            event.preventDefault();
            event.stopPropagation(); // ã‚¤ãƒ™ãƒ³ãƒˆã®ãƒãƒ–ãƒªãƒ³ã‚°ã‚’åœæ­¢
            currentContextMindMapId = mindMapId;
            const contextMenu = document.getElementById('context-menu');
            
            // ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’è¡¨ç¤º
            contextMenu.style.display = 'block';
            contextMenu.style.left = event.pageX + 'px';
            contextMenu.style.top = event.pageY + 'px';
            
            // ç”»é¢ç«¯ã«è¿‘ã„å ´åˆã®èª¿æ•´
            const rect = contextMenu.getBoundingClientRect();
            if (rect.right > window.innerWidth) {
                contextMenu.style.left = (event.pageX - rect.width) + 'px';
            }
            if (rect.bottom > window.innerHeight) {
                contextMenu.style.top = (event.pageY - rect.height) + 'px';
            }
        }

        // å€‹åˆ¥ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’é–‰ã˜ã‚‹
        function hideContextMenu() {
            document.getElementById('context-menu').style.display = 'none';
            currentContextMindMapId = null;
        }

        // headerãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’è¡¨ç¤º/éè¡¨ç¤º
        function toggleHeaderMenu(event) {
            event.stopPropagation();
            const menu = document.getElementById('header-menu');
            menu.classList.toggle('show');
        }

        // headerãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’é–‰ã˜ã‚‹
        function hideHeaderMenu() {
            document.getElementById('header-menu').classList.remove('show');
        }

        // ãƒã‚¤ãƒ³ãƒ‰ãƒãƒƒãƒ—ã‚’é–‹ãï¼ˆåˆ¥ã‚¿ãƒ–ï¼‰
        // ãƒã‚¤ãƒ³ãƒ‰ãƒãƒƒãƒ—ã‚’é–‹ãï¼ˆåŒä¸€ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦é·ç§»ï¼‰
        function openMindMap(id) {
            const mindMap = mindMaps.find(m => m.id === id);
            const folderId = mindMap ? (mindMap.folder || 'root') : 'root';
            const url = `viewer.html?id=${id}&returnFolder=${folderId}`;
            window.open(url, '_self');
        }

        // æ–°è¦ãƒã‚¤ãƒ³ãƒ‰ãƒãƒƒãƒ—ä½œæˆ
        window.createNewMindMap = createNewMindMap;
        window.toggleHeaderMenu = toggleHeaderMenu;
        function createNewMindMap() {
            document.getElementById('new-name').value = '';
            showModal('create-modal');
            setTimeout(() => document.getElementById('new-name').focus(), 100);
        }

        // æ–°è¦ä½œæˆç¢ºå®š
        function confirmCreateMindMap() {
            const name = document.getElementById('new-name').value.trim();
            if (!name) {
                alert('åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }
            const newMindMap = {
                id: generateUUID(),
                name: name,
                createdAt: Date.now(),
                updatedAt: Date.now(),
                folder: selectedFolderId,
                rootNode: {
                    id: generateUUID(),
                    text: name,
                    children: []
                }
            };
            mindMaps.push(newMindMap);
            saveMindMaps();
            closeModal('create-modal');
            renderMindMapList();
            // æ–°è¦ä½œæˆå¾Œã™ãã«é–‹ã
            openMindMap(newMindMap.id);
        }

        // åå‰ç·¨é›†
        function editName(id) {
            const mindMap = mindMaps.find(m => m.id === id);
            if (!mindMap) return;
            
            editingMindMapId = id;
            document.getElementById('edit-name').value = mindMap.name;
            showModal('edit-modal');
            setTimeout(() => document.getElementById('edit-name').focus(), 100);
            hideContextMenu();
        }

        // åå‰ç·¨é›†ç¢ºå®š
        function confirmEditName() {
            const newName = document.getElementById('edit-name').value.trim();
            if (!newName) {
                alert('åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }

            const mindMap = mindMaps.find(m => m.id === editingMindMapId);
            if (mindMap) {
                mindMap.name = newName;
                mindMap.updatedAt = Date.now();
                // ãƒ«ãƒ¼ãƒˆãƒãƒ¼ãƒ‰ã®åå‰ã‚‚æ›´æ–°
                if (mindMap.rootNode) {
                    mindMap.rootNode.text = newName;
                }
                saveMindMaps();
                renderMindMapList();
            }

            closeModal('edit-modal');
            editingMindMapId = null;
        }

        // ãƒã‚¤ãƒ³ãƒ‰ãƒãƒƒãƒ—å‰Šé™¤
        function deleteMindMap(id) {
            const mindMap = mindMaps.find(m => m.id === id);
            if (mindMap && confirm(`ãƒã‚¤ãƒ³ãƒ‰ãƒãƒƒãƒ—ã€Œ${mindMap.name}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\n\nã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã™ã“ã¨ãŒã§ãã¾ã›ã‚“ã€‚`)) {
                mindMaps = mindMaps.filter(m => m.id !== id);
                saveMindMaps();
                renderMindMapList();
            }
            hideContextMenu();
        }

        // ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆï¼ˆå˜ä½“ï¼‰
        function exportMindMap(id) {
            const mindMap = mindMaps.find(m => m.id === id);
            if (!mindMap) return;

            const dataStr = JSON.stringify(mindMap, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `${mindMap.name}.json`;
            link.click();
            URL.revokeObjectURL(url);
            hideContextMenu();
        }

        // ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆï¼ˆå…¨ã¦ï¼‰
        function exportAllMindMaps() {
            if (mindMaps.length === 0) {
                alert('ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã™ã‚‹ãƒã‚¤ãƒ³ãƒ‰ãƒãƒƒãƒ—ãŒã‚ã‚Šã¾ã›ã‚“');
                return;
            }

            const exportData = {
                mindMaps: mindMaps,
                folders: folders,
                exportDate: new Date().toISOString(),
                version: '2.0'
            };

            const dataStr = JSON.stringify(exportData, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `mindmaps_full_export_${new Date().toISOString().slice(0,10)}.json`;
            link.click();
            URL.revokeObjectURL(url);
        }

        // ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
        function importMindMap() {
            console.log('importMindMapé–¢æ•°ãŒå‘¼ã°ã‚Œã¾ã—ãŸ');
            document.getElementById('import-file').click();
        }

        // ãƒ•ã‚¡ã‚¤ãƒ«ã‚¤ãƒ³ãƒãƒ¼ãƒˆå‡¦ç†
        function handleFileImport(event) {
            console.log('handleFileImporté–‹å§‹');
            const file = event.target.files[0];
            console.log('é¸æŠã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«:', file);
            if (!file) {
                console.log('ãƒ•ã‚¡ã‚¤ãƒ«ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“');
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                console.log('ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿å®Œäº†');
                try {
                    const data = JSON.parse(e.target.result);
                    console.log('ã‚¤ãƒ³ãƒãƒ¼ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã®è§£æçµæœ:', data);
                    
                    if (data.mindMaps && Array.isArray(data.mindMaps)) {
                        // è¤‡æ•°ãƒã‚¤ãƒ³ãƒ‰ãƒãƒƒãƒ—å½¢å¼ï¼ˆãƒ•ã‚©ãƒ«ãƒ€æƒ…å ±æœ‰ç„¡å•ã‚ãšï¼‰
                        console.log('è¤‡æ•°ãƒã‚¤ãƒ³ãƒ‰ãƒãƒƒãƒ—å½¢å¼ã¨ã—ã¦å‡¦ç†');
                        handleMultipleMindMapsImport(data);
                    } else if (data.id && data.name && data.rootNode) {
                        // å˜ä½“ãƒã‚¤ãƒ³ãƒ‰ãƒãƒƒãƒ—å½¢å¼
                        console.log('å˜ä½“ãƒã‚¤ãƒ³ãƒ‰ãƒãƒƒãƒ—å½¢å¼ã¨ã—ã¦å‡¦ç†');
                        handleSingleMindMapImport(data);
                    } else {
                        throw new Error('ä¸æ­£ãªãƒ•ã‚¡ã‚¤ãƒ«å½¢å¼ã§ã™ã€‚ãƒã‚¤ãƒ³ãƒ‰ãƒãƒƒãƒ—ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚');
                    }
                } catch (error) {
                    console.error('ã‚¤ãƒ³ãƒãƒ¼ãƒˆã‚¨ãƒ©ãƒ¼:', error);
                    alert('ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
                }
                
                // ãƒ•ã‚¡ã‚¤ãƒ«å…¥åŠ›ã‚’ã‚¯ãƒªã‚¢
                event.target.value = '';
            };
            reader.readAsText(file);
        }

        // è¤‡æ•°ãƒã‚¤ãƒ³ãƒ‰ãƒãƒƒãƒ—ã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆå‡¦ç†
        function handleMultipleMindMapsImport(data) {
            console.log('handleMultipleMindMapsImporté–‹å§‹:', data);
            const importCount = data.mindMaps.length;
            
            // ãƒ•ã‚©ãƒ«ãƒ€æƒ…å ±ã®ç¢ºèªï¼ˆãƒãƒ¼ã‚¸ãƒ§ãƒ³1.0ã§ã¯å­˜åœ¨ã—ãªã„å ´åˆãŒã‚ã‚‹ï¼‰
            const hasfolders = data.folders && Array.isArray(data.folders) && data.folders.length > 0;
            console.log('hasfoldersåˆ¤å®š:', hasfolders);
            console.log('data.folders:', data.folders);
            
            // ãƒ•ã‚©ãƒ«ãƒ€æƒ…å ±ãŒå­˜åœ¨ã—ãªã„å ´åˆã€å…¨ã¦rootãƒ•ã‚©ãƒ«ãƒ€ã«é…ç½®
            if (!hasfolders) {
                console.log('ãƒ•ã‚©ãƒ«ãƒ€æƒ…å ±ãŒå­˜åœ¨ã—ãªã„ãŸã‚ã€å…¨ã¦rootãƒ•ã‚©ãƒ«ãƒ€ã«é…ç½®ã—ã¾ã™');
                data.mindMaps.forEach(mindMap => {
                    if (!mindMap.folder) {
                        mindMap.folder = 'root';
                    }
                });
            }
            
            const folderText = hasfolders ? `ã€${data.folders.length}å€‹ã®ãƒ•ã‚©ãƒ«ãƒ€` : '';
            const message = `${importCount}å€‹ã®ãƒã‚¤ãƒ³ãƒ‰ãƒãƒƒãƒ—${folderText}ã‚’ç™ºè¦‹ã—ã¾ã—ãŸã€‚\n\nã©ã®ã‚ˆã†ã«å‡¦ç†ã—ã¾ã™ã‹ï¼Ÿ`;
            
            const choice = confirm(message + '\n\nOK: ç¾åœ¨ã®ãƒ‡ãƒ¼ã‚¿ã‚’ç½®ãæ›ãˆã‚‹\nã‚­ãƒ£ãƒ³ã‚»ãƒ«: æ–°è¦è¿½åŠ ã™ã‚‹');
            console.log('ãƒ¦ãƒ¼ã‚¶ãƒ¼é¸æŠ:', choice ? 'ç½®æ›' : 'æ–°è¦è¿½åŠ ');
            
            if (choice) {
                // ãƒ‡ãƒ¼ã‚¿ç½®æ›
                mindMaps = data.mindMaps.map(mindMap => {
                    mindMap.updatedAt = Date.now();
                    return mindMap;
                });
                if (hasfolders) {
                    folders = data.folders;
                    selectedFolderId = 'root';
                }
                saveFolders();
                saveMindMaps();
                renderFolderTree();
                renderMindMapList();
                alert(`${data.mindMaps.length}å€‹ã®ãƒã‚¤ãƒ³ãƒ‰ãƒãƒƒãƒ—${folderText}ã§ãƒ‡ãƒ¼ã‚¿ã‚’ç½®ãæ›ãˆã¾ã—ãŸ`);
            } else {
                // æ–°è¦è¿½åŠ 
                console.log('æ–°è¦è¿½åŠ å‡¦ç†é–‹å§‹');
                let addedCount = 0;
                let addedFolderCount = 0;
                
                // ãƒ•ã‚©ãƒ«ãƒ€ã®æ–°è¦è¿½åŠ ï¼ˆåŒåãƒã‚§ãƒƒã‚¯ã¨æ–°è¦ä½œæˆï¼‰
                if (hasfolders) {
                    console.log('ãƒ•ã‚©ãƒ«ãƒ€ã‚¤ãƒ³ãƒãƒ¼ãƒˆé–‹å§‹:', data.folders);
                    console.log('æ—¢å­˜ãƒ•ã‚©ãƒ«ãƒ€:', folders);
                    
                    // ãƒ•ã‚©ãƒ«ãƒ€ã‚’éšå±¤é †ï¼ˆè¦ªã‹ã‚‰å­ã®é †ï¼‰ã§å‡¦ç†ã™ã‚‹ãŸã‚ã€ã‚½ãƒ¼ãƒˆ
                    const sortedFolders = [...data.folders].sort((a, b) => {
                        // rootãƒ•ã‚©ãƒ«ãƒ€ã‚’æœ€åˆã«
                        if (a.id === 'root') return -1;
                        if (b.id === 'root') return 1;
                        
                        // è¦ªãƒ•ã‚©ãƒ«ãƒ€ã‚’å­ãƒ•ã‚©ãƒ«ãƒ€ã‚ˆã‚Šå…ˆã«å‡¦ç†
                        const aDepth = getDepth(a.id, data.folders);
                        const bDepth = getDepth(b.id, data.folders);
                        return aDepth - bDepth;
                    });
                    
                    console.log('ã‚½ãƒ¼ãƒˆå¾Œãƒ•ã‚©ãƒ«ãƒ€:', sortedFolders);
                    
                    sortedFolders.forEach(importedFolder => {
                        console.log('å‡¦ç†ä¸­ãƒ•ã‚©ãƒ«ãƒ€:', importedFolder);
                        if (importedFolder.id === 'root') return; // rootãƒ•ã‚©ãƒ«ãƒ€ã¯ã‚¹ã‚­ãƒƒãƒ—
                        
                        // åŒåãƒ•ã‚©ãƒ«ãƒ€ã®ç¢ºèª
                        const existingFolderByName = folders.find(existing => 
                            existing.name === importedFolder.name && 
                            existing.parentId === importedFolder.parentId
                        );
                        
                        console.log('åŒåãƒ•ã‚©ãƒ«ãƒ€ãƒã‚§ãƒƒã‚¯çµæœ:', existingFolderByName);
                        
                        if (!existingFolderByName) {
                            // IDã®é‡è¤‡ãƒã‚§ãƒƒã‚¯ã‚‚è¡Œã„ã€å¿…è¦ãªã‚‰æ–°ã—ã„IDã‚’ç”Ÿæˆ
                            const existingFolderById = folders.find(existing => existing.id === importedFolder.id);
                            const originalId = importedFolder.id;
                            if (existingFolderById) {
                                importedFolder.id = generateUUID();
                                console.log('IDé‡è¤‡ã®ãŸã‚æ–°ã—ã„IDã‚’ç”Ÿæˆ:', originalId, '->', importedFolder.id);
                            }
                            
                            // childrené…åˆ—ã‚’åˆæœŸåŒ–
                            if (!importedFolder.children) {
                                importedFolder.children = [];
                            }
                            
                            // è¦ªãƒ•ã‚©ãƒ«ãƒ€ã®childrené…åˆ—ã«è¿½åŠ 
                            const parentFolder = folders.find(f => f.id === importedFolder.parentId);
                            console.log('è¦ªãƒ•ã‚©ãƒ«ãƒ€æ¤œç´¢çµæœ:', parentFolder);
                            if (parentFolder) {
                                if (!parentFolder.children) {
                                    parentFolder.children = [];
                                }
                                if (!parentFolder.children.includes(importedFolder.id)) {
                                    parentFolder.children.push(importedFolder.id);
                                    console.log('è¦ªãƒ•ã‚©ãƒ«ãƒ€ã«å­ã‚’è¿½åŠ :', parentFolder.id, '->', importedFolder.id);
                                }
                            }
                            
                            // IDãŒå¤‰æ›´ã•ã‚ŒãŸå ´åˆã€é–¢é€£ã™ã‚‹ãƒã‚¤ãƒ³ãƒ‰ãƒãƒƒãƒ—ã¨ãƒ•ã‚©ãƒ«ãƒ€ã®IDã‚‚æ›´æ–°
                            if (originalId !== importedFolder.id) {
                                data.mindMaps.forEach(mindMap => {
                                    if (mindMap.folder === originalId) {
                                        mindMap.folder = importedFolder.id;
                                    }
                                });
                                // å­ãƒ•ã‚©ãƒ«ãƒ€ã®parentIdã‚‚æ›´æ–°
                                sortedFolders.forEach(childFolder => {
                                    if (childFolder.parentId === originalId) {
                                        childFolder.parentId = importedFolder.id;
                                    }
                                });
                            }
                            
                            folders.push(importedFolder);
                            console.log('ãƒ•ã‚©ãƒ«ãƒ€ã‚’è¿½åŠ :', importedFolder);
                            addedFolderCount++;
                        } else {
                            // åŒåãƒ•ã‚©ãƒ«ãƒ€ãŒå­˜åœ¨ã™ã‚‹å ´åˆã€ã‚¤ãƒ³ãƒãƒ¼ãƒˆã™ã‚‹ãƒã‚¤ãƒ³ãƒ‰ãƒãƒƒãƒ—ã®ãƒ•ã‚©ãƒ«ãƒ€IDã‚’æ—¢å­˜ãƒ•ã‚©ãƒ«ãƒ€ã®IDã«å¤‰æ›´
                            const originalId = importedFolder.id;
                            data.mindMaps.forEach(mindMap => {
                                if (mindMap.folder === originalId) {
                                    mindMap.folder = existingFolderByName.id;
                                }
                            });
                            // å­ãƒ•ã‚©ãƒ«ãƒ€ã®parentIdã‚‚æ—¢å­˜ãƒ•ã‚©ãƒ«ãƒ€ã®IDã«å¤‰æ›´
                            sortedFolders.forEach(childFolder => {
                                if (childFolder.parentId === originalId) {
                                    childFolder.parentId = existingFolderByName.id;
                                }
                            });
                        }
                    });
                    
                    console.log('ãƒ•ã‚©ãƒ«ãƒ€ã‚¤ãƒ³ãƒãƒ¼ãƒˆå®Œäº†:', folders);
                    console.log('è¿½åŠ ã•ã‚ŒãŸãƒ•ã‚©ãƒ«ãƒ€æ•°:', addedFolderCount);
                }
                
                // ãƒã‚¤ãƒ³ãƒ‰ãƒãƒƒãƒ—ã®æ–°è¦è¿½åŠ 
                data.mindMaps.forEach(importedMindMap => {
                    // é‡è¤‡ãƒã‚§ãƒƒã‚¯
                    if (!mindMaps.find(existing => existing.id === importedMindMap.id)) {
                        importedMindMap.updatedAt = Date.now();
                        mindMaps.push(importedMindMap);
                        addedCount++;
                    }
                });
                
                if (addedCount > 0 || addedFolderCount > 0) {
                    saveFolders();
                    saveMindMaps();
                    renderFolderTree();
                    renderMindMapList();
                    const folderAddText = addedFolderCount > 0 ? `ã€${addedFolderCount}å€‹ã®ãƒ•ã‚©ãƒ«ãƒ€` : '';
                    alert(`${addedCount}å€‹ã®ãƒã‚¤ãƒ³ãƒ‰ãƒãƒƒãƒ—${folderAddText}ã‚’æ–°è¦è¿½åŠ ã—ã¾ã—ãŸ`);
                } else {
                    alert('æ–°è¦è¿½åŠ ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ã¯ã‚ã‚Šã¾ã›ã‚“ã§ã—ãŸï¼ˆé‡è¤‡ã®ãŸã‚ï¼‰');
                }
            }
        }

        // å˜ä½“ãƒã‚¤ãƒ³ãƒ‰ãƒãƒƒãƒ—ã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆå‡¦ç†
        function handleSingleMindMapImport(data) {
            // IDã®é‡è¤‡ãƒã‚§ãƒƒã‚¯
            const existingIndex = mindMaps.findIndex(m => m.id === data.id);
            
            if (existingIndex >= 0) {
                const choice = confirm(`åŒã˜IDã®ãƒã‚¤ãƒ³ãƒ‰ãƒãƒƒãƒ—ã€Œ${mindMaps[existingIndex].name}ã€ãŒæ—¢ã«å­˜åœ¨ã—ã¾ã™ã€‚\n\nOK: ä¸Šæ›¸ãã™ã‚‹\nã‚­ãƒ£ãƒ³ã‚»ãƒ«: æ–°è¦IDã§è¿½åŠ ã™ã‚‹`);
                
                if (choice) {
                    // ä¸Šæ›¸ãï¼ˆç¾åœ¨é¸æŠã•ã‚Œã¦ã„ã‚‹ãƒ•ã‚©ãƒ«ãƒ€ã«é…å±ï¼‰
                    mindMaps[existingIndex] = { ...data, updatedAt: Date.now(), folder: selectedFolderId };
                    saveMindMaps();
                    renderMindMapList();
                    alert(`ãƒã‚¤ãƒ³ãƒ‰ãƒãƒƒãƒ—ã€Œ${data.name}ã€ã‚’ä¸Šæ›¸ãã—ã¾ã—ãŸ`);
                } else {
                    // æ–°è¦IDã§è¿½åŠ ï¼ˆç¾åœ¨é¸æŠã•ã‚Œã¦ã„ã‚‹ãƒ•ã‚©ãƒ«ãƒ€ã«é…å±ï¼‰
                    const newMindMap = { ...data, id: generateUUID(), updatedAt: Date.now(), folder: selectedFolderId };
                    mindMaps.push(newMindMap);
                    saveMindMaps();
                    renderMindMapList();
                    alert(`ãƒã‚¤ãƒ³ãƒ‰ãƒãƒƒãƒ—ã€Œ${newMindMap.name}ã€ã‚’æ–°è¦è¿½åŠ ã—ã¾ã—ãŸ`);
                }
            } else {
                // æ–°è¦è¿½åŠ ï¼ˆç¾åœ¨é¸æŠã•ã‚Œã¦ã„ã‚‹ãƒ•ã‚©ãƒ«ãƒ€ã«é…å±ï¼‰
                const importedMindMap = { ...data, updatedAt: Date.now(), folder: selectedFolderId };
                mindMaps.push(importedMindMap);
                saveMindMaps();
                renderMindMapList();
                alert(`ãƒã‚¤ãƒ³ãƒ‰ãƒãƒƒãƒ—ã€Œ${importedMindMap.name}ã€ã‚’æ–°è¦è¿½åŠ ã—ã¾ã—ãŸ`);
            }
        }

        // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ä¿å­˜
        function saveMindMaps() {
            try {
                const data = {
                    mindMaps: mindMaps,
                    lastUpdated: Date.now()
                };
                localStorage.setItem('mindMaps', JSON.stringify(data));
            } catch (error) {
                console.error('ä¿å­˜ã‚¨ãƒ©ãƒ¼:', error);
                alert('ãƒ‡ãƒ¼ã‚¿ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ');
            }
        }

        // UUIDç”Ÿæˆ
        function generateUUID() {
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                const r = Math.random() * 16 | 0;
                const v = c == 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        }

        // ãƒ•ã‚©ãƒ«ãƒ€ã®éšå±¤æ·±åº¦ã‚’å–å¾—
        function getDepth(folderId, folderList = folders) {
            if (folderId === 'root' || !folderId) return 0;
            
            const folder = folderList.find(f => f.id === folderId);
            if (!folder) return 0;
            
            return 1 + getDepth(folder.parentId, folderList);
        }

        // ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º
        function showModal(modalId) {
            const modal = document.getElementById(modalId);
            modal.style.display = 'flex';
            setTimeout(() => modal.classList.add('show'), 10);
        }

        // ãƒ¢ãƒ¼ãƒ€ãƒ«éè¡¨ç¤º
        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            modal.classList.remove('show');
            modal.style.display = 'none';
        }

        // æ—¥ä»˜ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
        function formatDate(timestamp) {
            return new Date(timestamp).toLocaleString('ja-JP');
        }

        // HTMLã‚¨ã‚¹ã‚±ãƒ¼ãƒ—
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®š
        function setupEventListeners() {
            console.log('setupEventListenersé–‹å§‹');
            // ãƒ•ã‚¡ã‚¤ãƒ«ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
            const importFileElement = document.getElementById('import-file');
            console.log('import-fileè¦ç´ :', importFileElement);
            if (importFileElement) {
                importFileElement.addEventListener('change', handleFileImport);
                console.log('import-fileã®changeã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®šã—ã¾ã—ãŸ');
            } else {
                console.error('import-fileè¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
            }
            
            document.getElementById('folder-name').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    const confirmBtn = document.getElementById('folder-modal-confirm-btn');
                    if (confirmBtn.onclick) confirmBtn.onclick();
                }
            });

            // ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ç”¨ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©
            // ãƒ•ã‚©ãƒ«ãƒ€ç”¨ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ãƒãƒ³ãƒ‰ãƒ©
            window.handleFolderKeydown = function(e, folderId) {
                switch(e.key) {
                    case 'Enter':
                    case ' ': // ã‚¹ãƒšãƒ¼ã‚¹ã‚­ãƒ¼
                        e.preventDefault();
                        selectedFolderId = folderId;
                        renderFolderTree();
                        renderMindMapList();
                        break;
                    case 'ArrowUp':
                        e.preventDefault();
                        focusPreviousFolder(e.target);
                        break;
                    case 'ArrowDown':
                        e.preventDefault();
                        focusNextFolder(e.target);
                        break;
                    case 'Tab':
                        // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®Tabå‹•ä½œã‚’ç¶­æŒ
                        break;
                    case 'ContextMenu':
                    case 'F10':
                        if (e.shiftKey) { // Shift+F10 for context menu
                            e.preventDefault();
                            if (folderId !== 'root') {
                                const rect = e.target.getBoundingClientRect();
                                const fakeEvent = {
                                    preventDefault: () => {},
                                    stopPropagation: () => {},
                                    pageX: rect.left + rect.width / 2,
                                    pageY: rect.top + rect.height / 2
                                };
                                window.showFolderContextMenu(fakeEvent, folderId);
                            }
                        }
                        break;
                }
            };

            // ãƒã‚¤ãƒ³ãƒ‰ãƒãƒƒãƒ—ç”¨ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ãƒãƒ³ãƒ‰ãƒ©
            window.handleMindMapKeydown = function(e, mindMapId) {
                switch(e.key) {
                    case 'Enter':
                    case ' ': // ã‚¹ãƒšãƒ¼ã‚¹ã‚­ãƒ¼
                        e.preventDefault();
                        openMindMap(mindMapId);
                        break;
                    case 'ArrowUp':
                        e.preventDefault();
                        focusPreviousMindMap(e.target);
                        break;
                    case 'ArrowDown':
                        e.preventDefault();
                        focusNextMindMap(e.target);
                        break;
                    case 'Tab':
                        // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®Tabå‹•ä½œã‚’ç¶­æŒ
                        break;
                    case 'ContextMenu':
                    case 'F10':
                        if (e.shiftKey) { // Shift+F10 for context menu
                            e.preventDefault();
                            const rect = e.target.getBoundingClientRect();
                            const fakeEvent = {
                                preventDefault: () => {},
                                stopPropagation: () => {},
                                pageX: rect.left + rect.width / 2,
                                pageY: rect.top + rect.height / 2
                            };
                            showContextMenu(fakeEvent, mindMapId);
                        }
                        break;
                }
            };

            // ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ç§»å‹•ç”¨ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
            function focusPreviousFolder(current) {
                const folders = document.querySelectorAll('.folder-item.focusable');
                const currentIndex = Array.from(folders).indexOf(current);
                if (currentIndex > 0) {
                    folders[currentIndex - 1].focus();
                }
            }

            function focusNextFolder(current) {
                const folders = document.querySelectorAll('.folder-item.focusable');
                const currentIndex = Array.from(folders).indexOf(current);
                if (currentIndex < folders.length - 1) {
                    folders[currentIndex + 1].focus();
                }
            }

            function focusPreviousMindMap(current) {
                const mindMaps = document.querySelectorAll('.mindmap-item.focusable');
                const currentIndex = Array.from(mindMaps).indexOf(current);
                if (currentIndex > 0) {
                    mindMaps[currentIndex - 1].focus();
                }
            }

            function focusNextMindMap(current) {
                const mindMaps = document.querySelectorAll('.mindmap-item.focusable');
                const currentIndex = Array.from(mindMaps).indexOf(current);
                if (currentIndex < mindMaps.length - 1) {
                    mindMaps[currentIndex + 1].focus();
                }
            }

            // Escapeã‚­ãƒ¼ã§ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    // è¡¨ç¤ºä¸­ã®ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’æ¢ã—ã¦é–‰ã˜ã‚‹
                    const modals = document.querySelectorAll('.modal');
                    modals.forEach(modal => {
                        if (modal.style.display === 'flex' || modal.classList.contains('show')) {
                            modal.classList.remove('show');
                            modal.style.display = 'none';
                        }
                    });
                    // ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚‚é–‰ã˜ã‚‹
                    hideContextMenu();
                    window.hideFolderContextMenu();
                    hideHeaderMenu();
                }
            });

            // Enterã‚­ãƒ¼ã§ãƒ¢ãƒ¼ãƒ€ãƒ«ç¢ºå®š
            document.getElementById('new-name').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') confirmCreateMindMap();
            });
            
            document.getElementById('edit-name').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') confirmEditName();
            });

            // ãƒ¢ãƒ¼ãƒ€ãƒ«å¤–ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
            document.addEventListener('click', function(e) {
                if (e.target.classList.contains('modal')) {
                    e.target.style.display = 'none';
                }
                // ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚‚é–‰ã˜ã‚‹
                if (!e.target.closest('#context-menu')) {
                    hideContextMenu();
                }
                // ãƒ•ã‚©ãƒ«ãƒ€ç”¨ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚‚é–‰ã˜ã‚‹
                if (!e.target.closest('#folder-context-menu')) {
                    window.hideFolderContextMenu();
                }
                // headerãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚‚é–‰ã˜ã‚‹
                if (!e.target.closest('.header-menu')) {
                    hideHeaderMenu();
                }
            });
        }

        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã®åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', function() {
            loadMindMaps();
            setupEventListeners();
            // setIntervalã«ã‚ˆã‚‹loadMindMaps()ã®å®šæœŸå‘¼ã³å‡ºã—ã‚’ä¸€æ™‚çš„ã«ç„¡åŠ¹åŒ–
            // ç§»å‹•ç›´å¾Œã®çŠ¶æ…‹ã‚’ç¶­æŒã§ãã‚‹ã‹ç¢ºèªã™ã‚‹
        });

// ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
window.showFolderContextMenu = showFolderContextMenu;
window.hideFolderContextMenu = hideFolderContextMenu;
    </script>
</body>
</html>